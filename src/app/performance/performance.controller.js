(function() {
  'use strict';

  angular
    .module('tuktukV2Dahboard')
    .controller('PerformanceController', PerformanceController);

  /** @ngInject */
  function PerformanceController($scope, $log, $rootScope, PerformanceService, PerformanceHandler, NgTableParams, API, $resource) {
    var vm = this
    $scope.dates = {};
    $scope.dates.startDate = moment().subtract(30, 'days').format("YYYY-MM-DD")
    $scope.dates.endDate = moment().format("YYYY-MM-DD")
    //$scope.dates = { startDate: moment('2013-09-20'), endDate: moment('2013-09-25') };
    vm.timeFrequency = [{label:"Per Hour", value:"hour"},{label:"Per Day", value:"day"}]
    vm.selectedFrequency = vm.timeFrequency[0]

    var RiderAPI = API + "rider"
    var DriverAPI = API + "driver"
    var TripAPI ;

    var startDate, endDate;
    this.changeFrequency = function()
    {

    }
    $scope.$watch('dates', function(newValue, oldValue) {
     // console.log(new, old);
 //     vm.requestTableParams.page(1)
 //     vm.requestTableParams.reload();
      getData()
    })
    function getData()
    {
      startDate =  moment($scope.dates.startDate).startOf('day').format("YYYYMMDDHH").toString()
      endDate =  moment($scope.dates.endDate).endOf('day').format("YYYYMMDDHH").toString()

      PerformanceService.getTrips({startDate:startDate, endDate:endDate,city:"indore",count:1,page:1}, {}, function (response) {

        PerformanceHandler.trips = response;
        console.log('get Trips ',PerformanceHandler.getTrips())
        vm.trips = PerformanceHandler.getTrips();
      }, function (err) {
        console.log(err)
        $scope.error = true;
      });

    }
    $scope.options = {
      chart: {
        type: 'cumulativeLineChart',
        height: 450,
        margin : {
          top: 20,
          right: 20,
          bottom: 60,
          left: 65
        },
        x: function(d){ return d[0]; },
        y: function(d){ return d[1]/100; },
        average: function(d) { return d.mean/100; },

        color: d3.scale.category10().range(),
        duration: 300,
        useInteractiveGuideline: true,
        clipVoronoi: false,

        xAxis: {
          axisLabel: 'X Axis',
          tickFormat: function(d) {
            return d3.time.format('%m/%d/%y')(new Date(d))
          },
          showMaxMin: false,
          staggerLabels: true
        },

        yAxis: {
          axisLabel: 'Y Axis',
          tickFormat: function(d){
            return d3.format(',.1%')(d);
          },
          axisLabelDistance: 20
        }
      }
    };
    $scope.data =[{"key":"Requests","values":[[1083297600000,2],[1085976000000,1.5],[1088568000000,4.4681318138177],[1091246400000,7.0242541001353],[1093924800000,7.5709603667586],[1096516800000,20.612245065736],[1099195200000,21.698065237316],[1101790800000,40.501189458018],[1104469200000,50.464679413194],[1107147600000,48.917421973355],[1109566800000,63.75093654916],[1112245200000,59.07249912646],[1114833600000,43.373158880492],[1117512000000,54.490918947556],[1120104000000,56.661178852079],[1122782400000,73.450103545496],[1125460800000,71.714526354907],[1128052800000,85.221664349607],[1130734800000,77.769261392481],[1133326800000,95.9665287165],[1136005200000,107.59132116397],[1138683600000,127.25740096723],[1141102800000,122.1391749883],[1143781200000,126.53657279774],[1146369600000,132.3930099297],[1149048000000,120.11238242904],[1151640000000,118.4140891775],[1154318400000,107.92918924621],[1156996800000,110.28057249569],[1159588800000,117.20485334692],[1162270800000,141.33556756948],[1164862800000,159.59452727893],[1167541200000,167.09801853304],[1170219600000,185.46849659215],[1172638800000,184.8247409999],[1175313600000,195.63155213887],[1177905600000,207.40597044171],[1180584000000,230.55966698196],[1183176000000,239.55649035292],[1185854400000,241.35915085208],[1188532800000,239.89428956243],[1191124800000,260.47781917715],[1193803200000,276.39457482225],[1196398800000,258.66530682672],[1199077200000,250.98846121893],[1201755600000,226.89902618127],[1204261200000,227.29009273807],[1206936000000,218.6647665435],[1209528000000,232.46605902918],[1212206400000,253.25667081117],[1214798400000,235.82505363925],[1217476800000,229.70112774254],[1220155200000,225.18472705952],[1222747200000,189.13661746552],[1225425600000,149.46533007301],[1228021200000,131.00340772114],[1230699600000,135.18341728866],[1233378000000,109.15296887173],[1235797200000,84.61477254976],[1238472000000,100.60810015326],[1241064000000,141.5013489561],[1243742400000,142.50405083675],[1246334400000,139.81192372672],[1249012800000,177.78205544583],[1251691200000,194.73691933074],[1254283200000,209.00838460225],[1256961600000,198.1985587742],[1259557200000,222.37102417812],[1262235600000,234.2458108125],[1264914000000,228.26087689346],[1267333200000,248.8189512625],[1270008000000,270.57301075186],[1272600000000,292.6460432255],[1275278400000,265.94088520518],[1277870400000,237.82887467569],[1280548800000,265.55973314204],[1283227200000,248.30877330928],[1285819200000,278.14870066912],[1288497600000,292.69260960288],[1291093200000,300.84263809599],[1293771600000,326.17253914628],[1296450000000,337.69335966505],[1298869200000,339.73260965121],[1301544000000,346.87865120765],[1304136000000,347.92991526628],[1306814400000,342.04627502669],[1309406400000,333.45386231233],[1312084800000,323.15034181243],[1314763200000,295.66126882331],[1317355200000,251.48014579253],[1320033600000,295.15424257905],[1322629200000,294.54766764397],[1325307600000,295.72906119051],[1327986000000,325.73351347613],[1330491600000,340.16106061186],[1333166400000,345.1551407149],[1335758400000,337.10259395679],[1338436800000,318.68216333837],[1341028800000,317.03683945246],[1343707200000,318.53549659997],[1346385600000,332.85381464104],[1348977600000,337.36534373477],[1351656000000,350.27872156161],[1354251600000,349.451288761]],"mean":250},{"key":"Cancelled","mean":125,"values":[[1083297600000,-3.7454058855943],[1085976000000,-3.6096667436314],[1088568000000,-0.844000393495],[1091246400000,2.0921565171691],[1093924800000,3.5874194844361],[1096516800000,13.742776534056],[1099195200000,13.212577494462],[1101790800000,24.567562260634],[1104469200000,34.54369934365],[1107147600000,36.438736927704],[1109566800000,46.453174659855],[1112245200000,43.82536923544],[1114833600000,32.036699833653],[1117512000000,41.191928040141],[1120104000000,40.301151852023],[1122782400000,54.922174023466],[1125460800000,49.538009616222],[1128052800000,61.911998981277],[1130734800000,56.139287982733],[1133326800000,71.780099623014],[1136005200000,78.474613851439],[1138683600000,90.069363092366],[1141102800000,87.449910167102],[1143781200000,87.030640692381],[1146369600000,87.053437436941],[1149048000000,76.263029236276],[1151640000000,72.995735254929],[1154318400000,63.349908186291],[1156996800000,66.25347413232],[1159588800000,75.943546587481],[1162270800000,93.889549035453],[1164862800000,106.18074433002],[1167541200000,116.39729488562],[1170219600000,129.09440567885],[1172638800000,123.07049577958],[1175313600000,129.38531055124],[1177905600000,132.05431954171],[1180584000000,148.86060871993],[1183176000000,157.06946698484],[1185854400000,155.1290957388],[1188532800000,155.14737474392],[1191124800000,159.70646945738],[1193803200000,166.44021916278],[1196398800000,159.05963386166],[1199077200000,151.38121182455],[1201755600000,132.02441123108],[1204261200000,121.93110210702],[1206936000000,112.64545460548],[1209528000000,122.17722331147],[1212206400000,133.65410878087],[1214798400000,120.20304048123],[1217476800000,123.06288589052],[1220155200000,125.33598074057],[1222747200000,103.50539786253],[1225425600000,85.917420810943],[1228021200000,71.250132356683],[1230699600000,71.308439405118],[1233378000000,52.287271484242],[1235797200000,30.329193047772],[1238472000000,44.133440571375],[1241064000000,77.654211210456],[1243742400000,73.749802969425],[1246334400000,70.337666717565],[1249012800000,102.69722724876],[1251691200000,117.6358910935],[1254283200000,128.55351774786],[1256961600000,119.21420882198],[1259557200000,139.32979337027],[1262235600000,149.71606246357],[1264914000000,144.42340669795],[1267333200000,161.64446359053],[1270008000000,180.23071774437],[1272600000000,199.09511476051],[1275278400000,180.10778306442],[1277870400000,158.5023728441],[1280548800000,177.5735362385],[1283227200000,162.91091118751],[1285819200000,183.4105336191],[1288497600000,194.03065670573],[1291093200000,201.23297214328],[1293771600000,222.60154078445],[1296450000000,233.35556801977],[1298869200000,231.22452435045],[1301544000000,237.84432503045],[1304136000000,235.55799131184],[1306814400000,232.11873570751],[1309406400000,226.62381538123],[1312084800000,219.34811113539],[1314763200000,198.69242285581],[1317355200000,168.90235629066],[1320033600000,202.64725756733],[1322629200000,203.05389378105],[1325307600000,204.85986680865],[1327986000000,229.77085616585],[1330491600000,239.65202435959],[1333166400000,242.33012622734],[1335758400000,234.11773262149],[1338436800000,221.47846307887],[1341028800000,216.98308827912],[1343707200000,218.37781386755],[1346385600000,229.39368622736],[1348977600000,230.54656412916],[1351656000000,243.06087025523],[1354251600000,244.24733578385]]}]
    /*vm.requestTableParams = new NgTableParams({}, {
      getData: function(params) {
        // ajax request to api
        startDate = $scope.dates.startDate;
        endDate = $scope.dates.endDate;
        if(vm.selectedFrequency.value=='hour')
        {
          startDate =  moment(startDate).startOf('day').format("YYYYMMDDHH").toString()
          endDate =  moment(endDate).endOf('day').format("YYYYMMDDHH").toString()
          TripAPI = $resource(API + "trip/hour?startDate="+startDate+"&endDate="+endDate+"&city=indore")
        }
        else
        {
          startDate =  moment(startDate).startOf('day').format("YYYYMMDD").toString()
          endDate =  moment(endDate).endOf('day').format("YYYYMMDD").toString()
          TripAPI = $resource(API + "trip/day?startDate="+startDate+"&endDate="+endDate+"&city=indore")
        }
        return TripAPI.query(params.url()).$promise.then(function(data) {
          params.total(data); // recal. page nav controls
          return data;
        });
      }
    });*/


  }
})();
